image: ubuntu:24.04

clone:
  depth: full

pipelines:
  default:
    - step:
        name: Cortex CLI Image Scan
        services:
          - docker
        script:
          - set -euo pipefail
          - export IMAGE_REF="spellbook:${BITBUCKET_COMMIT}"
          
          # 1. Standard setup & dependency install (omitted for brevity)
          - apt-get update && apt-get install -y --no-install-recommends python3 python3-requests curl jq libhyperscan5 libatomic1
          
          # 2. Build the Image
          - docker build -t "${IMAGE_REF}" .

          # 3. Export Image to Tarball (The "Exit 2" Fix)
          - echo "Exporting image to tarball for scanning..."
          - docker save "${IMAGE_REF}" -o image.tar

          # 4. Download and Install Cortex CLI
          - |
            DOWNLOAD_RESPONSE=$(curl -fsSL "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
              -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" \
              -H "Authorization: ${CORTEX_API_KEY}")
            CRTX_URL=$(echo "$DOWNLOAD_RESPONSE" | jq -r '.signed_url')
            curl -fsSL -o cortexcli "$CRTX_URL"
            chmod +x cortexcli

          # 5. Run the Scan using the file path
          # In v0.18.0, all options must come BEFORE the file path
          - |
            ./cortexcli \
              --api-base-url "${CORTEX_API_URL}" \
              --api-key "${CORTEX_API_KEY}" \
              --api-key-id "${CORTEX_API_KEY_ID}" \
              --support \
              image scan \
              --archive \
              --name "${IMAGE_REF}" \
              image.tar | tee scan_output.txt | python3 cortex_cli_reporting_enhancement.py